<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trợ lý AI tra cứu văn bản đến</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
    }
    .chat-container {
        width: 90%;
        max-width: 900px;
        margin: 50px auto;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        max-height: 90vh;
        overflow: hidden;
    }
    .chat-box {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        position: relative;
    }
    .suggestions {
        margin: 10px 0;
        display: flex;
        justify-content: space-around;
        gap: 8px;
        flex-wrap: nowrap;
    }
    .suggestion {
        font-size: 0.85rem;
        background-color: #e7f1ff;
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background-color 0.2s ease;
    }
    .suggestion:hover {
        background-color: #a9d1ff;
    }
    .user-message, .gemini-message, .image-message, .loading-message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
    }
    .user-message {
        background-color: #d1e7ff;
        align-self: flex-end;
        margin-left: auto;
    }
    .gemini-message {
        background-color: #e3f7e6;
    }
    .image-message img {
        max-width: 100px;
        height: auto;
        border-radius: 8px;
        margin-top: 5px;
        display: block;
    }
    .loading-message {
        background-color: #f0f0f0;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    .loading-message::before {
        content: '';
        width: 20px;
        height: 20px;
        border: 3px solid #ccc;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    input[type="text"] {
        width: calc(100% - 110px);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-right: 10px;
        box-sizing: border-box;
    }
    input[type="file"] {
        margin: 10px 0;
    }
    .preview-message {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
    }
    button {
        padding: 10px 20px;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        margin: 5px 3px;
        font-size: 1rem;
    }
    .custom-file-upload {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 8px;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        margin: 5px 3px;
        font-size: 1rem;
    }
    .input-row {
        display: flex;
        align-items: center;
    }
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
    }
</style>

<!-- MathJax để hiển thị công thức toán học -->
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>

<div class="chat-container">
    <div class="error-message" id="error-message">Lỗi: Không thể kết nối đến Gemini API. Vui lòng kiểm tra API key.</div>
    <div class="chat-box" id="chat-box"></div>
    <div class="suggestions" id="suggestions-container"></div>
    <div class="input-row">
        <input type="text" id="user-input" placeholder="Tin nhắn Gemini AI" />
        <button onclick="sendMessage()" title="Nhấn để gửi tin nhắn">GỬI</button>
        <button onclick="startRecognition()" title="Chat bằng giọng nói">Tải âm thanh</button>
        <label for="image-input" class="custom-file-upload" title="Tải ảnh lên"> Tải ảnh</label>
        <input type="file" id="image-input" accept="image/*" onchange="handleImageUpload()" style="display: none;" />
    </div>
    <div class="preview-message" id="preview-message"></div>
</div>

<script>
    // Cấu hình Gemini API
    const GEMINI_API_KEY = 'AIzaSyCXItaCs7x_GhzvtkMlURDhR0KOUd3yEqo'; // Gemini API key
    const MODEL_NAME = 'gemini-2.0-flash'; 

    const localData = [
        { "prompt": "Bạn cần tra cứu văn bản gì?", "completion": "Công văn, kế hoạch, báo cáo, hướng dẫn,..." },
        { "prompt": "Bạn cần trích xuất thông tin gì?", "completion": "Trích yếu, ngày ban hành, cơ quan ban hành,..." },
    ];

    const allSuggestions = [
        "Hãy thống kê các văn bản có hạn báo cáo trong tháng 10 năm 2025",
        "Hãy tìm các văn bản có đề cập đến Thông tư 29",
		"Hãy cho biết tên file PDF của văn bản hướng dẫn thực hiện nhiệm vụ năm học 2025 - 2026",
	];

    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const errorMessage = document.getElementById('error-message');
    const previewMessage = document.getElementById('preview-message');
    const imageInput = document.getElementById('image-input');
    const suggestionsContainer = document.getElementById('suggestions-container');

    // Kiểm tra khi trang load
    window.addEventListener('load', function() {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            errorMessage.style.display = 'block';
            errorMessage.innerText = 'Lỗi: Vui lòng nhập Gemini API key hợp lệ trong mã nguồn.';
        }
        const voiceButton = document.querySelector('button[title="Chat bằng giọng nói"]');
        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
            voiceButton.style.display = 'none';
        }
    });

    function getRandomSuggestions(exclude = []) {
        const filtered = allSuggestions.filter(s => !exclude.includes(s));
        const shuffled = filtered.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 3);
    }

    function displaySuggestions(currentSuggestions) {
        suggestionsContainer.innerHTML = '';
        currentSuggestions.forEach(suggestion => {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.classList.add('suggestion');
            suggestionDiv.title = suggestion;
            suggestionDiv.textContent = suggestion;
            suggestionDiv.onclick = () => {
                userInput.value = suggestion;
                sendMessage();
                const newSuggestions = getRandomSuggestions([suggestion]);
                displaySuggestions(newSuggestions);
            };
            suggestionsContainer.appendChild(suggestionDiv);
        });
    }

    displaySuggestions(getRandomSuggestions());

    function findBestMatch(input) {
        const normalizedInput = input.toLowerCase().trim();
        for (let item of localData) {
            const keywords = item.prompt.split(' ');
            if (keywords.every(k => normalizedInput.includes(k))) {
                return item.completion;
            }
        }
        return null;
    }

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.classList.add('loading-message');
        loadingDiv.id = 'loading-message';
        loadingDiv.textContent = 'Đang xử lý...';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return loadingDiv;
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading-message');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            errorMessage.style.display = 'block';
            errorMessage.innerText = 'Lỗi: Vui lòng nhập Gemini API key hợp lệ trong mã nguồn.';
            return;
        }

        appendMessage('user', message);
        userInput.value = '';
        previewMessage.style.display = 'none';

        const localResponse = findBestMatch(message);
        if (localResponse) {
            appendMessage('gemini', localResponse);
            return;
        }

        const loadingDiv = showLoading();

        try {
            console.log('Gửi yêu cầu đến Gemini API với key:', GEMINI_API_KEY);
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: message
                                }
                            ]
                        }
                    ]
                }),
            });

            hideLoading();

            const data = await response.json();
            if (!response.ok) {
                const errorMessage = data?.error?.message || 'Không thể kết nối đến Gemini API';
                console.error('Lỗi Gemini API:', data);
                appendMessage('gemini', `Lỗi: ${errorMessage}`);
                return;
            }
            if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                appendMessage('gemini', 'Không nhận được phản hồi hợp lệ từ Gemini API.');
                return;
            }

            const reply = data.candidates[0].content.parts[0].text;
            appendMessage('gemini', reply);
        } catch (error) {
            hideLoading();
            console.error('Lỗi kết nối mạng:', error);
            appendMessage('gemini', `Lỗi kết nối mạng: ${error.message}`);
        }
    }

    function appendMessage(sender, message, imageUrl = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add(sender === 'user' ? 'user-message' : 'gemini-message');

        if (imageUrl) {
            messageDiv.classList.add('image-message');
            const img = document.createElement('img');
            img.src = imageUrl;
            messageDiv.appendChild(img);
        }

        if (message) {
            const textDiv = document.createElement('div');
            textDiv.innerHTML = message.replace(/\n/g, "<br>");
            messageDiv.appendChild(textDiv);
        }

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().catch(err => {
                console.error('Lỗi MathJax:', err);
            });
        }
    }

    userInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') sendMessage();
    });

    function startRecognition() {
        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
            alert('Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói.');
            return;
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'vi-VN';

        recognition.onresult = function(event) {
            const voiceInput = event.results[0][0].transcript;
            userInput.value = voiceInput;
            previewMessage.innerText = `Bạn vừa nói: "${voiceInput}"`;
            previewMessage.style.display = 'block';
        };

        recognition.onerror = function(event) {
            alert('Lỗi nhận dạng giọng nói: ' + event.error);
        };

        recognition.start();
    }

    async function handleImageUpload() {
        const file = imageInput.files[0];
        if (!file) return;

        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            errorMessage.style.display = 'block';
            errorMessage.innerText = 'Lỗi: Vui lòng nhập Gemini API key hợp lệ trong mã nguồn.';
            return;
        }

        const reader = new FileReader();
        reader.onload = async function(event) {
            const base64Image = event.target.result;
            const base64Data = base64Image.split(',')[1];

            appendMessage('user', 'Bạn đã tải lên 1 hình ảnh, đợi tôi một chút...', base64Image);

            const loadingDiv = showLoading();

            try {
                console.log('Gửi yêu cầu phân tích hình ảnh đến Gemini API với key:', GEMINI_API_KEY);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: "Hãy phân tích và mô tả nội dung của hình ảnh này một cách chi tiết."
                                    },
                                    {
                                        inline_data: {
                                            mime_type: file.type,
                                            data: base64Data
                                        }
                                    }
                                ]
                            }
                        ]
                    }),
                });

                hideLoading();

                const data = await response.json();
                if (!response.ok) {
                    const errorMessage = data?.error?.message || 'Không thể phân tích hình ảnh';
                    console.error('Lỗi Gemini API:', data);
                    appendMessage('gemini', `Lỗi: ${errorMessage}`);
                    return;
                }
                if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                    appendMessage('gemini', 'Không nhận được phản hồi hợp lệ từ Gemini API.');
                    return;
                }

                const description = data.candidates[0].content.parts[0].text;
                appendMessage('gemini', description);
            } catch (error) {
                hideLoading();
                console.error('Lỗi kết nối mạng:', error);
                appendMessage('gemini', `Lỗi kết nối mạng khi phân tích hình ảnh: ${error.message}`);
            }
        };

        reader.readAsDataURL(file);
    }
</script>
</body>
</html>
